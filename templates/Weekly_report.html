<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Matching Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #f8f9fa; }
        .dashboard-container { width: 80vw; max-width: 1200px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 32px; position: relative; }
        .hero-header { display: flex; align-items: center; justify-content: center; gap: 32px; margin-bottom: 2.5rem; }
        .dashboard-title { font-size:2.3rem; font-weight: bold; }
        .table-section { margin-top: 2rem; }
        .table-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; }
        .file-upload-box { margin-bottom: 2rem; }
        .puzzle-logo { max-width: 120px; max-height: 120px; border-radius: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.10); background: #fff; padding: 8px; }
        .dashboard-bg-puzzle { position: absolute; right: 2vw; top: 2vw; opacity: 0.08; z-index: 0; max-width: 300px; pointer-events: none; }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.2s;
        }
        .loading-box {
            background: #fff;
            border-radius: 16px;
            padding: 40px 60px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            text-align: center;
        }
        .loading-spinner {
            width: 3rem; height: 3rem;
            border: 0.4rem solid #e0e0e0;
            border-top: 0.4rem solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 18px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <div id="loading-overlay" class="loading-overlay" style="display:none;">
        <div class="loading-box">
            <div class="loading-spinner"></div>
            <div class="fw-bold fs-5 mb-1">Processing your data...</div>
            <div class="text-secondary">Please wait while we generate your report.</div>
        </div>
    </div>
    <img src="/static/Puzzle_logo.png" class="dashboard-bg-puzzle" alt="Puzzle Logo Background" />
    <div class="hero-header">
        <img src="/static/Puzzle_logo.png" class="puzzle-logo" alt="Puzzle Logo" />
        <div>
            <h2 class="dashboard-title">Productivity & Efficiency report</h2>
            <div class="text-secondary">Upload your Company Roster and Charge Capture files .</div>
        </div>
    </div>
    <form id="upload-form" enctype="multipart/form-data">
        <div class="row file-upload-box">
            <div class="col-md-6 mb-3">
                <label for="roster-file" class="form-label">Company Roster (.csv or .xlsx)</label>
                <input class="form-control" type="file" id="roster-file" name="roster-file" accept=".csv,.xlsx" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="charge-file" class="form-label">Charge Capture (.csv or .xlsx)</label>
                <input class="form-control" type="file" id="charge-file" name="charge-file" accept=".csv,.xlsx" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6 d-none">
                <label for="day-field" class="form-label">Day</label>
                <input class="form-control" type="text" id="day-field" name="day" placeholder="Enter Day">
            </div>
            <div class="col-md-6">
                <label for="date-field" class="form-label">Date</label>
                <input class="form-control" type="date" id="date-field" name="date" required>
            </div>
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg px-5">Upload & Match</button>
        </div>
    </form>
    <div id="results-section" style="display:none;">
        <div class="table-section">
            <div class="table-title">Matched Providers</div>
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Company Roster Name</th>
                        <th>Charge Capture Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="matched-table-body">
                </tbody>
            </table>
        </div>
        <div class="table-section">
            <div class="table-title">Unmatched Providers</div>
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Company Roster Name</th>
                        <th>Charge Capture Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="unmatched-table-body">
                </tbody>
            </table>
        </div>
    <!-- Download buttons will be appended here -->
    </div>
</div>
<script>
function renderTable(data, tbodyId) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '';
    data.filter(row => row.score <= 90 && row.score >= 60).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.company_roster || ''}</td><td>${row.charge_capture_name || ''}</td><td>${row.score != null ? row.score.toFixed(2) : ''}</td>`;
        tbody.appendChild(tr);
    });
}

const form = document.getElementById('upload-form');
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    // Clear previous download containers to avoid duplicates
    ['pptx-download-div', 'workbook-download-div'].forEach(id => {
        const el = document.getElementById(id);
        if (el && el.parentNode) el.parentNode.removeChild(el);
    });
    const rosterFile = document.getElementById('roster-file').files[0];
    const chargeFile = document.getElementById('charge-file').files[0];
    const dayField = document.getElementById('day-field').value;
    const dateField = document.getElementById('date-field').value;
    if (!rosterFile || !chargeFile) {
        alert('Please upload both files.');
        return;
    }
    const formData = new FormData();
    formData.append('Roster', rosterFile);
    formData.append('captureFile', chargeFile);
    formData.append('day', document.getElementById('day-field').value);
    formData.append('date', document.getElementById('date-field').value);

    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';

    try {
    const response = await fetch('/api/productivity/upload_data', {
        method: 'POST',
        body: formData,
        headers: {
            'X-API-KEY': '0de34eb2-cb58-4f1e-a7b8-2e55cf0e5331'
        }
    });
        const result = await response.json();
        if (result.success && result.matched_providers && result.unmatched_providers) {
            document.getElementById('results-section').style.display = 'block';
            renderTable(result.matched_providers, 'matched-table-body');
            renderTable(result.unmatched_providers, 'unmatched-table-body');
            // Add download links similar to Margin page (deduplicated)
            // PowerPoint download
            if (result.pptx_path) {
                const pptxDivId = 'pptx-download-div';
                let existingPptxDiv = document.getElementById(pptxDivId);
                const resultsSection = document.getElementById('results-section');
                if (!existingPptxDiv && resultsSection) {
                    const downloadDiv = document.createElement('div');
                    downloadDiv.id = pptxDivId;
                    downloadDiv.className = 'text-center my-3';
                    const a = document.createElement('a');
                    a.href = `/${result.pptx_path}?delete=1`;
                    a.className = 'btn btn-success';
                    a.setAttribute('download', '');
                    a.textContent = 'Download PowerPoint Report';
                    downloadDiv.appendChild(a);
                    resultsSection.appendChild(downloadDiv);
                    // auto-delete after download click (quiet)
                    attachAutoDelete(a, ['Weekly_report_report.pptx']);
                } else if (existingPptxDiv) {
                    const a = existingPptxDiv.querySelector('a');
                    if (a) a.href = `/${result.pptx_path}?delete=1`;
                    attachAutoDelete(a, ['Weekly_report_report.pptx']);
                }
            }

            // Workbook (Excel)
            const workbookDivId = 'workbook-download-div';
            let workbookDiv = document.getElementById(workbookDivId);
            const resultsSection2 = document.getElementById('results-section');
            if (!workbookDiv && resultsSection2) {
                workbookDiv = document.createElement('div');
                workbookDiv.id = workbookDivId;
                workbookDiv.className = 'text-center my-3';
                const link = document.createElement('a');
                link.href = '/uploads/Work_book.xlsx?delete=1';
                link.className = 'btn btn-outline-success';
                link.textContent = 'Download Workbook (Excel)';
                workbookDiv.appendChild(link);
                resultsSection2.appendChild(workbookDiv);
                // auto-delete after download click (quiet)
                attachAutoDelete(link, ['Work_book.xlsx']);
            } else if (workbookDiv) {
                const link = workbookDiv.querySelector('a');
                if (link) link.href = '/uploads/Work_book.xlsx?delete=1';
                attachAutoDelete(link, ['Work_book.xlsx']);
            }
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                const noteId = 'verification-note';
                let noteDiv = document.getElementById(noteId);
                if (!noteDiv) {
                    noteDiv = document.createElement('div');
                    noteDiv.id = noteId;
                    noteDiv.className = 'alert alert-warning mt-3';
                    noteDiv.innerHTML = `
                        <strong>Important:</strong> The table below only shows provider matches with scores between <b>60 and 90</b>, which are likely to be potential mistakes. Please carefully review these names before using the report. If you find any incorrect matches, update the names in your roster file so they match the charge capture file, then re-upload for best results.`;
                    resultsSection.insertAdjacentElement('afterbegin', noteDiv);
                } else {
                    noteDiv.style.display = 'block';
                }

                // Add a manual cleanup button (deduped)
                const cleanupDivId = 'cleanup-div';
                let cleanupDiv = document.getElementById(cleanupDivId);
                if (!cleanupDiv) {
                    cleanupDiv = document.createElement('div');
                    cleanupDiv.id = cleanupDivId;
                    cleanupDiv.className = 'text-center my-2';
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-danger btn-sm';
                    btn.textContent = 'Delete generated files';
                    btn.onclick = () => deleteGenerated(['Weekly_report_report.pptx', 'Work_book.xlsx']);
                    resultsSection.appendChild(cleanupDiv);
                    cleanupDiv.appendChild(btn);
                }
            }
        } else {
            alert('Processing failed or no results returned.');
        }
    } catch (err) {
        alert('Error uploading: ' + err.message);
    } finally {
        // Hide loading overlay
        document.getElementById('loading-overlay').style.display = 'none';
    }
});

document.getElementById('date-field').addEventListener('change', function() {
    const dateValue = this.value;
    if (dateValue) {
        const dateObj = new Date(dateValue);
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday','Saturday'];
        document.getElementById('day-field').value = days[dateObj.getDay()];
    } else {
        document.getElementById('day-field').value = '';
    }
});

// Helper to delete generated files via API
async function deleteGenerated(files) {
    try {
        const resp = await fetch('/api/uploads/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-KEY': '0de34eb2-cb58-4f1e-a7b8-2e55cf0e5331'
            },
            body: JSON.stringify({ filenames: files })
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || data.success === false) {
            alert('Delete failed' + (data.error ? `: ${data.error}` : '.'));
        } else {
            const msg = `Deleted: ${(data.deleted||[]).join(', ') || 'none'}\nNot found: ${(data.not_found||[]).join(', ') || 'none'}`;
            alert(msg);
        }
    } catch (e) {
        alert('Delete error: ' + e.message);
    }
}

// Quiet auto-delete on click, delayed to allow download to start
function attachAutoDelete(anchor, files) {
    if (!anchor || anchor.__autoDeleteAttached) return;
    anchor.__autoDeleteAttached = true;
    anchor.addEventListener('click', () => {
        setTimeout(() => autoDeleteGenerated(files), 1500);
    });
}
async function autoDeleteGenerated(files) {
    try {
        await fetch('/api/uploads/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-KEY': '0de34eb2-cb58-4f1e-a7b8-2e55cf0e5331'
            },
            body: JSON.stringify({ filenames: files })
        });
    } catch (_) { /* ignore */ }
}
</script>
</body>
</html>
