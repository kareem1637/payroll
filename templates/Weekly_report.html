<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Matching Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #f8f9fa; }
        .dashboard-container { width: 80vw; max-width: 1200px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 32px; position: relative; }
        .hero-header { display: flex; align-items: center; justify-content: center; gap: 32px; margin-bottom: 2.5rem; }
        .dashboard-title { font-size:2.3rem; font-weight: bold; }
        .table-section { margin-top: 2rem; }
        .table-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; }
        .file-upload-box { margin-bottom: 2rem; }
        .puzzle-logo { max-width: 120px; max-height: 120px; border-radius: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.10); background: #fff; padding: 8px; }
        .dashboard-bg-puzzle { position: absolute; right: 2vw; top: 2vw; opacity: 0.08; z-index: 0; max-width: 300px; pointer-events: none; }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.2s;
        }
        .loading-box {
            background: #fff;
            border-radius: 16px;
            padding: 40px 60px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            text-align: center;
        }
        .loading-spinner {
            width: 3rem; height: 3rem;
            border: 0.4rem solid #e0e0e0;
            border-top: 0.4rem solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 18px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <div id="loading-overlay" class="loading-overlay" style="display:none;">
        <div class="loading-box">
            <div class="loading-spinner"></div>
            <div class="fw-bold fs-5 mb-1">Processing your data...</div>
            <div class="text-secondary">Please wait while we generate your report.</div>
        </div>
    </div>
    <img src="/static/Puzzle_logo.png" class="dashboard-bg-puzzle" alt="Puzzle Logo Background" />
    <div class="hero-header">
        <img src="/static/Puzzle_logo.png" class="puzzle-logo" alt="Puzzle Logo" />
        <div>
            <h2 class="dashboard-title">Productivity & Efficiency report</h2>
            <div class="text-secondary">Upload your Company Roster and Charge Capture files .</div>
        </div>
    </div>
    <form id="upload-form" enctype="multipart/form-data">
        <div class="row file-upload-box">
            <div class="col-md-6 mb-3">
                <label for="roster-file" class="form-label">Company Roster (.csv or .xlsx)</label>
                <input class="form-control" type="file" id="roster-file" name="roster-file" accept=".csv,.xlsx" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="charge-file" class="form-label">Charge Capture (.csv or .xlsx)</label>
                <input class="form-control" type="file" id="charge-file" name="charge-file" accept=".csv,.xlsx" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6 d-none">
                <label for="day-field" class="form-label">Day</label>
                <input class="form-control" type="text" id="day-field" name="day" placeholder="Enter Day">
            </div>
            <div class="col-md-6">
                <label for="date-field" class="form-label">Date</label>
                <input class="form-control" type="date" id="date-field" name="date" required>
            </div>
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg px-5">Upload & Match</button>
        </div>
    </form>
    <div id="results-section" style="display:none;">
        <div class="table-section">
            <div class="table-title">Matched Providers</div>
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Company Roster Name</th>
                        <th>Charge Capture Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="matched-table-body">
                </tbody>
            </table>
        </div>
        <div class="table-section">
            <div class="table-title">Unmatched Providers</div>
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Company Roster Name</th>
                        <th>Charge Capture Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="unmatched-table-body">
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
function renderTable(data, tbodyId) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '';
    data.filter(row => row.score <= 90 && row.score >= 60).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.company_roster || ''}</td><td>${row.charge_capture_name || ''}</td><td>${row.score != null ? row.score.toFixed(2) : ''}</td>`;
        tbody.appendChild(tr);
    });
}

const form = document.getElementById('upload-form');
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const rosterFile = document.getElementById('roster-file').files[0];
    const chargeFile = document.getElementById('charge-file').files[0];
    const dayField = document.getElementById('day-field').value;
    const dateField = document.getElementById('date-field').value;
    if (!rosterFile || !chargeFile) {
        alert('Please upload both files.');
        return;
    }
    const formData = new FormData();
    formData.append('Roster', rosterFile);
    formData.append('captureFile', chargeFile);
    formData.append('day', document.getElementById('day-field').value);
    formData.append('date', document.getElementById('date-field').value);

    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';

    try {
    const response = await fetch('/api/productivity/upload_data', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success && result.matched_providers && result.unmatched_providers) {
            document.getElementById('results-section').style.display = 'block';
            renderTable(result.matched_providers, 'matched-table-body');
            renderTable(result.unmatched_providers, 'unmatched-table-body');
            if (result.pptx_path) {
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'text-center my-3';
                downloadDiv.innerHTML = `<a href='/${result.pptx_path}' class='btn btn-success' download>Download PowerPoint Report</a>`;
                document.getElementById('results-section').appendChild(downloadDiv);
            }
            const verificationNote = document.getElementById('verification-note');
            if (verificationNote) {
                verificationNote.style.display = 'block';
            }
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'alert alert-warning mt-3';
                noteDiv.innerHTML = `
                    <strong>Important:</strong> The table below only shows provider matches with scores between <b>60 and 90</b>, which are likely to be potential mistakes. Please carefully review these names before using the report. If you find any incorrect matches, update the names in your roster file so they match the charge capture file, then re-upload for best results.`;
                resultsSection.insertAdjacentElement('afterbegin', noteDiv);
            }
        } else {
            alert('Processing failed or no results returned.');
        }
    } catch (err) {
        alert('Error uploading: ' + err.message);
    } finally {
        // Hide loading overlay
        document.getElementById('loading-overlay').style.display = 'none';
    }
});

document.getElementById('date-field').addEventListener('change', function() {
    const dateValue = this.value;
    if (dateValue) {
        const dateObj = new Date(dateValue);
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday','Saturday'];
        document.getElementById('day-field').value = days[dateObj.getDay()];
    } else {
        document.getElementById('day-field').value = '';
    }
});
</script>
</body>
</html>
